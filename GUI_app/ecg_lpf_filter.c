#include "ecg_lpf_filter.h"
#include "ecg_data_process.h"
#include "arm_const_structs.h"
//#include "bsp_loop_buffer.h"
////const float32_t fir32LP[NUM_TAPS] = {
////  -0.002440747673444,-0.0006869469814085, 0.001692348532845,0.0006181713245129,
////  0.0009128907262127, 0.005326675691079, -0.00422155352732, -0.02442149486348,
////  -0.002448918393223,   0.0546576073623,  0.03238323405778, -0.07817700917996,
////   -0.08502019403856,   0.0720232118841,   0.1380081904586, -0.02949440228581,
////     0.8425778738116, -0.02949440228581,   0.1380081904586,   0.0720232118841,
////   -0.08502019403856, -0.07817700917996,  0.03238323405778,   0.0546576073623,
////  -0.002448918393223, -0.02442149486348, -0.00422155352732, 0.005326675691079,
////  0.0009128907262127,0.0006181713245129, 0.001692348532845,-0.0006869469814085,
////  -0.002440747673444
////};

//const float32_t fir32LP[NUM_TAPS] = {
//0.000242211636776779, 0.000185824430238675, 9.05799055192093e-05, -2.70226915198025e-05, -0.000145639422183592, -0.000242371394638364, -0.000296619132962647, -0.000293993645318515, -0.000229646529462620, -0.000110327675843962, 4.54470415353235e-05, 0.000209502296725888, 0.000348380868105086, 0.000429500324573309, 0.000428103681753331, 0.000333644440083820, 0.000154112086112874, -8.30049340747454e-05, -0.000333886820641813, -0.000545635004065550, -0.000666619279888576, -0.000658059086175874, -0.000504405214974967, -0.000219996084758744, 0.000150052751062492, 0.000535735738880181, 0.000854418220975704, 0.00102755381440291, 0.000998666406824193, 0.000748699453291992, 0.000304936157038325, -0.000259321026988666, -0.000835373672796710, -0.00129891280800413, -0.00153562225937663, -0.00146755544105626, -0.00107448894009899, -0.000404928518784850, 0.000426833552165135, 0.00125849179982848, 0.00191000613885878, 0.00222103485857412, 0.00208802407339159, 0.00149275577740745, 0.000515204115481514, -0.000673716577822531, -0.00183995032437234, -0.00273062101643643, -0.00312684564898232, -0.00289437891133551, -0.00202088282398370, -0.000630462771214440, 0.00102983364561842, 0.00263128083009649, 0.00382620428199173, 0.00432067184459523, 0.00394245607176792, 0.00268926670788841, 0.000745134802335178, -0.00154144090502649, -0.00371638358577043, -0.00530677222085633, -0.00591950623830950, -0.00533206528410693, -0.00355546726125874, -0.000853656973086625, 0.00228864934932197, 0.00524751851747862, 0.00737808935545030, 0.00814817188627772, 0.00726069103532884, 0.00473852408453042, 0.000950748901110042, -0.00343045257560711, -0.00753972116216463, -0.0104789124824576, -0.0114999150192453, -0.0101748726159017, -0.00651825064023247, -0.00103167596122958, 0.00534476609763534, 0.0113741349099435, 0.0157383437232760, 0.0172932786264997, 0.0153181961596495, 0.00971165933482657, 0.00109248539101890, -0.00922141263757105, -0.0193630174480385, -0.0271788391858185, -0.0305666429572225, -0.0278349419653311, -0.0180238509370759, -0.00113020363909710, 0.0218066286969451, 0.0487800494644371, 0.0770481539637646, 0.103491255032862, 0.125042080892564, 0.139122244382700, 0.144016103587301, 0.139122244382700, 0.125042080892564, 0.103491255032862, 0.0770481539637646, 0.0487800494644371, 0.0218066286969451, -0.00113020363909710, -0.0180238509370759, -0.0278349419653311, -0.0305666429572225, -0.0271788391858185, -0.0193630174480385, -0.00922141263757105, 0.00109248539101890, 0.00971165933482657, 0.0153181961596495, 0.0172932786264997, 0.0157383437232760, 0.0113741349099435, 0.00534476609763534, -0.00103167596122958, -0.00651825064023247, -0.0101748726159017, -0.0114999150192453, -0.0104789124824576, -0.00753972116216463, -0.00343045257560711, 0.000950748901110042, 0.00473852408453042, 0.00726069103532884, 0.00814817188627772, 0.00737808935545030, 0.00524751851747862, 0.00228864934932197, -0.000853656973086625, -0.00355546726125874, -0.00533206528410693, -0.00591950623830950, -0.00530677222085633, -0.00371638358577043, -0.00154144090502649, 0.000745134802335178, 0.00268926670788841, 0.00394245607176792, 0.00432067184459523, 0.00382620428199173, 0.00263128083009649, 0.00102983364561842, -0.000630462771214440, -0.00202088282398370, -0.00289437891133551, -0.00312684564898232, -0.00273062101643643, -0.00183995032437234, -0.000673716577822531, 0.000515204115481514, 0.00149275577740745, 0.00208802407339159, 0.00222103485857412, 0.00191000613885878, 0.00125849179982848, 0.000426833552165135, -0.000404928518784850, -0.00107448894009899, -0.00146755544105626, -0.00153562225937663, -0.00129891280800413, -0.000835373672796710, -0.000259321026988666, 0.000304936157038325, 0.000748699453291992, 0.000998666406824193, 0.00102755381440291, 0.000854418220975704, 0.000535735738880181, 0.000150052751062492, -0.000219996084758744, -0.000504405214974967, -0.000658059086175874, -0.000666619279888576, -0.000545635004065550, -0.000333886820641813, -8.30049340747454e-05, 0.000154112086112874, 0.000333644440083820, 0.000428103681753331, 0.000429500324573309, 0.000348380868105086, 0.000209502296725888, 4.54470415353235e-05, -0.000110327675843962, -0.000229646529462620, -0.000293993645318515, -0.000296619132962647, -0.000242371394638364, -0.000145639422183592, -2.70226915198025e-05, 9.05799055192093e-05, 0.000185824430238675, 0.000242211636776779

//};


const float32_t fir32LP[NUM_TAPS] = {
  -7.484454468902e-22,-3.269336712398e-06,-1.365915864079e-05,-5.014073980636e-06,
  6.804735231975e-05,0.0001662336497003,7.965197426322e-05,-0.0003784662837741,
  -0.0008928563387901,-0.0005280588787408, 0.001284875839485, 0.003225662215767,
     0.0022425431358,-0.003157084585057,-0.009028737319977,-0.007219934929014,
   0.006057868257093,  0.02144319498633,  0.01971312591228,-0.009448071870685,
   -0.04806332586811, -0.05291973061693,  0.01224382260678,   0.1388254178822,
     0.2663085232723,   0.3199984843521,   0.2663085232723,   0.1388254178822,
    0.01224382260678, -0.05291973061693, -0.04806332586811,-0.009448071870685,
    0.01971312591228,  0.02144319498633, 0.006057868257093,-0.007219934929014,
  -0.009028737319977,-0.003157084585057,   0.0022425431358, 0.003225662215767,
   0.001284875839485,-0.0005280588787408,-0.0008928563387901,-0.0003784662837741,
  7.965197426322e-05,0.0001662336497003,6.804735231975e-05,-5.014073980636e-06,
  -1.365915864079e-05,-3.269336712399e-06,-7.484454468902e-22
};

static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS - 1];


arm_fir_instance_f32 S;

void arm_fir_Init(void)
{
	arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&fir32LP[0], &firStateF32[0], BLOCK_SIZE);
}


#define MAX_COUNT 5

static float buf[MAX_COUNT]={0};    /* 数据缓冲区 */
static float sum=0;               /* N个数据的算术和 */
static int pcnt=0;                 /* 数据个数 */
static int pos=0;                 /* 缓冲区位置 */

/*
 * 滑动平均值滤波。
 * 每次新进来一个数据，就将最早进来的数据丢掉，然后计算包括新数据在内的N个数据的算术平均值。
 *
 * 每调用一次，就加入一个新数据，并得到当前的滤波值。
 */
float alg(float new_val)
{
    /* 用一个减法，就做了"丢弃最旧的数据，加入最新的数据"这一操作 */
    sum += (new_val - buf[pos]);

    buf[pos] = new_val;

    /* pos,cnt可能可以合在一起，但用两个变量，更清晰一些 */
    // pos &= 0xf;
    pos = (pos + 1) % MAX_COUNT;

    /* 个数不足时，cnt是实际个数，个数足够时，cnt最多也只是MAX_COUNT */
    //if (cnt < MAX_COUNT)
    //  cnt++;
    pcnt += (pcnt < MAX_COUNT);

    return sum / MAX_COUNT;
}



void arm_fir_f32_lp(void)
{
	
	float32_t *inputf32, *outputf32;

	if(ReadAdsInBuffer() && WriterEcgOutBuffer()){//指针定位成功
		/* 初始化输入输出缓存指针 */
		inputf32 = (float32_t *)InFifoDev.rp;
		outputf32 =(float32_t *)OutFifoDev.wp;
	  /* 初始化结构体S */
	 
	  /* 实现FIR滤波 */
		arm_fir_f32(&S, inputf32, outputf32, BLOCK_SIZE);
		
		//my_memcpy(OutFifoDev.wp,InFifoDev.rp,BLOCK_SIZE*4);
		InFifoDev.state[InFifoDev.read_front]=Empty;
		InFifoDev.read_front=(InFifoDev.read_front+1)%PACK_NUM;//切换读缓存块
	
		OutFifoDev.state[OutFifoDev.writer_rear]=Full;
		OutFifoDev.writer_rear=(OutFifoDev.writer_rear+1)%PACK_NUM;//切换写缓存块
	}

}


